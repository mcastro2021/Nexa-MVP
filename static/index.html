<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constructora E2E Platform - Gesti√≥n Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="app()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">üèóÔ∏è Constructora E2E Platform</h1>
            <p class="text-xl text-gray-600">Gesti√≥n completa de proyectos, stock, RRHH y KPIs con Inteligencia Artificial</p>
            <div class="mt-4 flex justify-center space-x-4">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">Wood Frame</span>
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Steel Frame</span>
                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">IA Integrada</span>
            </div>
        </header>

        <!-- Login Section -->
        <div x-show="!isLoggedIn" class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">Iniciar Sesi√≥n</h2>
            <form @submit.prevent="login">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input x-model="loginForm.email" type="email" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a</label>
                    <input x-model="loginForm.password" type="password" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <!-- Demo Users -->
            <div class="mt-4 text-sm text-gray-600">
                <p class="font-semibold mb-2">Usuarios Demo:</p>
                <div class="space-y-1">
                    <div>üë§ Cliente: cliente@demo.com</div>
                    <div>üè¢ Admin: admin@demo.com</div>
                    <div>üì¶ Log√≠stica: logistica@demo.com</div>
                    <div> Ejecutivo: ejecutivo@demo.com</div>
                    <div class="text-xs">Contrase√±a: password123</div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div x-show="isLoggedIn" class="space-y-8">
            <!-- User Info & Navigation -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">Bienvenido, <span x-text="user.nombre"></span></h2>
                        <p class="text-gray-600">Rol: <span x-text="user.role" class="font-semibold"></span></p>
                    </div>
                    <button @click="logout" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                        Cerrar Sesi√≥n
                    </button>
                </div>
                
                <!-- Navigation Tabs -->
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                    <button @click="activeTab = 'dashboard'" 
                            :class="activeTab === 'dashboard' ? 'bg-white text-blue-600' : 'text-gray-600'"
                            class="px-4 py-2 rounded-md transition-colors">
                        üìä Dashboard
                    </button>
                    <button @click="activeTab = 'proyectos'" 
                            :class="activeTab === 'proyectos' ? 'bg-white text-blue-600' : 'text-gray-600'"
                            class="px-4 py-2 rounded-md transition-colors">
                        üèóÔ∏è Proyectos
                    </button>
                    <button x-show="user.role === 'ADMIN' || user.role === 'LOGISTICA'" 
                            @click="activeTab = 'stock'" 
                            :class="activeTab === 'stock' ? 'bg-white text-blue-600' : 'text-gray-600'"
                            class="px-4 py-2 rounded-md transition-colors">
                        üì¶ Stock
                    </button>
                    <button x-show="user.role === 'ADMIN' || user.role === 'EJECUTIVO'" 
                            @click="activeTab = 'empleados'" 
                            :class="activeTab === 'empleados' ? 'bg-white text-blue-600' : 'text-gray-600'"
                            class="px-4 py-2 rounded-md transition-colors">
                        üë• Empleados
                    </button>
                    <button @click="activeTab = 'chatbot'" 
                            :class="activeTab === 'chatbot' ? 'bg-white text-blue-600' : 'text-gray-600'"
                            class="px-4 py-2 rounded-md transition-colors">
                        ü§ñ IA Chatbot
                    </button>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div x-show="activeTab === 'dashboard'" class="space-y-6">
                <!-- KPIs Section -->
                <div x-show="user.role === 'EJECUTIVO' || user.role === 'ADMIN'" class="grid md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üìä KPIs Obras</h3>
                        <div x-show="kpis.obras" class="space-y-2">
                            <p>Total: <span x-text="kpis.obras.total" class="font-bold text-blue-600"></span></p>
                            <p>En Progreso: <span x-text="kpis.obras.en_progreso" class="font-bold text-orange-600"></span></p>
                            <p>Finalizadas: <span x-text="kpis.obras.finalizadas" class="font-bold text-green-600"></span></p>
                            <p>Promedio: <span x-text="kpis.obras.promedioDias" class="font-bold text-purple-600"></span> d√≠as</p>
                        </div>
                        <button @click="loadKPIs('obras')" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                            Cargar
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üí∞ KPIs Finanzas</h3>
                        <div x-show="kpis.finanzas" class="space-y-2">
                            <p>Ingresos: $<span x-text="kpis.finanzas.ingresos?.toLocaleString()" class="font-bold text-green-600"></span></p>
                            <p>Egresos: $<span x-text="kpis.finanzas.egresos?.toLocaleString()" class="font-bold text-red-600"></span></p>
                            <p>Utilidad: $<span x-text="kpis.finanzas.utilidad?.toLocaleString()" class="font-bold text-blue-600"></span></p>
                            <p>ROI: <span x-text="kpis.finanzas.roi" class="font-bold text-purple-600"></span>%</p>
                        </div>
                        <button @click="loadKPIs('finanzas')" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                            Cargar
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">üë• KPIs Personal</h3>
                        <div x-show="kpis.personal" class="space-y-2">
                            <p>Total: <span x-text="kpis.personal.total_empleados" class="font-bold text-blue-600"></span></p>
                            <p>Activos: <span x-text="kpis.personal.activos" class="font-bold text-green-600"></span></p>
                            <p>Salario Prom: $<span x-text="kpis.personal.salario_promedio?.toLocaleString()" class="font-bold text-purple-600"></span></p>
                        </div>
                        <button @click="loadKPIs('personal')" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                            Cargar
                        </button>
                    </div>
                </div>

                <!-- Charts Section -->
                <div x-show="user.role === 'EJECUTIVO' || user.role === 'ADMIN'" class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Progreso de Proyectos</h3>
                        <canvas id="projectsChart" width="400" height="200"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üí∞ Flujo Financiero</h3>
                        <canvas id="financeChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Proyectos Tab -->
            <div x-show="activeTab === 'proyectos'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Proyectos</h3>
                    <div x-show="projects.length > 0" class="space-y-4">
                        <template x-for="project in projects" :key="project.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-lg" x-text="project.nombre"></h4>
                                        <p class="text-gray-600" x-text="`${project.tipo} - ${project.m2}m¬≤`"></p>
                                        <p class="text-sm text-gray-500" x-text="`Direcci√≥n: ${project.direccion}`"></p>
                                        <p class="text-sm text-gray-500" x-text="`Cliente: ${project.cliente}`"></p>
                                    </div>
                                    <div class="text-right">
                                        <span :class="{
                                            'bg-green-100 text-green-800': project.estado === 'FINALIZADO',
                                            'bg-orange-100 text-orange-800': project.estado === 'EN_PROGRESO',
                                            'bg-blue-100 text-blue-800': project.estado === 'PLANIFICACION'
                                        }" class="px-2 py-1 rounded-full text-xs font-semibold" x-text="project.estado"></span>
                                        <p class="text-sm font-semibold text-gray-700 mt-1">$<span x-text="project.presupuesto?.toLocaleString()"></span></p>
                                    </div>
                                </div>
                                
                                <!-- Hitos del Proyecto -->
                                <div class="mt-4">
                                    <h5 class="font-semibold text-gray-700 mb-2">Hitos:</h5>
                                    <div class="space-y-2">
                                        <template x-for="hito in milestones" :key="hito.id">
                                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                                <div>
                                                    <span x-text="hito.nombre" class="font-medium"></span>
                                                    <span x-text="` - ${hito.responsable}`" class="text-sm text-gray-600"></span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                                        <div class="bg-blue-600 h-2 rounded-full" :style="`width: ${hito.progreso}%`"></div>
                                                    </div>
                                                    <span class="text-sm font-semibold" x-text="`${hito.progreso}%`"></span>
                                                    <span :class="{
                                                        'bg-green-100 text-green-800': hito.estado === 'COMPLETADO',
                                                        'bg-orange-100 text-orange-800': hito.estado === 'EN_PROGRESO',
                                                        'bg-gray-100 text-gray-800': hito.estado === 'PENDIENTE'
                                                    }" class="px-2 py-1 rounded-full text-xs" x-text="hito.estado"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <button @click="loadProjects" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        Cargar Proyectos
                    </button>
                </div>
            </div>

            <!-- Stock Tab -->
            <div x-show="activeTab === 'stock'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üì¶ Gesti√≥n de Stock</h3>
                    <div x-show="stock.length > 0" class="space-y-4">
                        <template x-for="item in stock" :key="item.id">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-lg" x-text="item.nombre"></h4>
                                        <p class="text-gray-600" x-text="`SKU: ${item.sku}`"></p>
                                        <p class="text-sm text-gray-500" x-text="`Proveedor: ${item.proveedor}`"></p>
                                    </div>
                                    <div class="text-right">
                                        <span :class="{
                                            'bg-red-100 text-red-800': item.alerta === 'CRITICO',
                                            'bg-orange-100 text-orange-800': item.alerta === 'BAJO',
                                            'bg-green-100 text-green-800': item.alerta === 'NORMAL'
                                        }" class="px-2 py-1 rounded-full text-xs font-semibold" x-text="item.alerta"></span>
                                        <p class="text-sm font-semibold text-gray-700 mt-1">
                                            Stock: <span x-text="item.stock"></span> <span x-text="item.unidad"></span>
                                        </p>
                                        <p class="text-sm text-gray-500">M√≠n: <span x-text="item.minimo"></span></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <button @click="loadStock" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Cargar Stock
                    </button>
                </div>
            </div>

            <!-- Proveedores Tab -->
            <div x-show="activeTab === 'proveedores'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ü§ù Proveedores</h3>
                    <div x-show="suppliers.length > 0" class="space-y-4">
                        <template x-for="supplier in suppliers" :key="supplier.id">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-lg" x-text="supplier.nombre"></h4>
                                        <p class="text-gray-600" x-text="supplier.especialidad"></p>
                                        <p class="text-sm text-gray-500" x-text="supplier.email"></p>
                                        <p class="text-sm text-gray-500" x-text="supplier.telefono"></p>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex items-center space-x-1">
                                            <span class="text-yellow-500">‚òÖ</span>
                                            <span class="font-semibold" x-text="supplier.rating"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <button @click="loadSuppliers" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Cargar Proveedores
                    </button>
                </div>
            </div>

            <!-- Empleados Tab -->
            <div x-show="activeTab === 'empleados'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üë• Gesti√≥n de Personal</h3>
                    <div x-show="employees.length > 0" class="space-y-4">
                        <template x-for="employee in employees" :key="employee.id">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-lg" x-text="employee.nombre"></h4>
                                        <p class="text-gray-600" x-text="`${employee.puesto} - ${employee.area}`"></p>
                                        <p class="text-sm text-gray-500" x-text="`Antig√ºedad: ${employee.antiguedad} a√±os`"></p>
                                    </div>
                                    <div class="text-right">
                                        <span :class="{
                                            'bg-green-100 text-green-800': employee.estado === 'ACTIVO',
                                            'bg-red-100 text-red-800': employee.estado === 'INACTIVO'
                                        }" class="px-2 py-1 rounded-full text-xs font-semibold" x-text="employee.estado"></span>
                                        <p class="text-sm font-semibold text-gray-700 mt-1">$<span x-text="employee.salario?.toLocaleString()"></span></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <button @click="loadEmployees" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Cargar Empleados
                    </button>
                </div>
            </div>

            <!-- Chatbot Tab -->
            <div x-show="activeTab === 'chatbot'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ü§ñ Chatbot con Inteligencia Artificial</h3>
                    <div class="space-y-4">
                        <div class="flex space-x-2">
                            <input x-model="chatbotQuery" type="text" placeholder="Haz una pregunta sobre tu proyecto, pagos, materiales, personal..." 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button @click="askChatbot" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                Preguntar
                            </button>
                        </div>
                        
                        <!-- AI Response -->
                        <div x-show="chatbotResponse" class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-200">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="text-blue-600 text-lg">ü§ñ</span>
                                <span class="font-semibold text-gray-800">Respuesta IA:</span>
                                <span :class="{
                                    'bg-green-100 text-green-800': chatbotResponse.sentimiento === 'positive',
                                    'bg-red-100 text-red-800': chatbotResponse.sentimiento === 'negative',
                                    'bg-gray-100 text-gray-800': chatbotResponse.sentimiento === 'neutral'
                                }" class="px-2 py-1 rounded-full text-xs" x-text="chatbotResponse.sentimiento"></span>
                            </div>
                            
                            <p x-text="chatbotResponse.respuesta" class="text-gray-700 mb-3"></p>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>Tipo:</strong> <span x-text="chatbotResponse.tipo" class="capitalize"></span>
                                    </p>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>Confianza:</strong> <span x-text="Math.round(chatbotResponse.confianza * 100)"></span>%
                                    </p>
                                </div>
                                
                                <div>
                                    <p class="text-sm text-gray-600 mb-2"><strong>Recomendaciones:</strong></p>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <template x-for="rec in chatbotResponse.recomendaciones" :key="rec">
                                            <li class="flex items-center space-x-1">
                                                <span class="text-blue-500">‚Ä¢</span>
                                                <span x-text="rec"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Questions -->
                        <div class="mt-4">
                            <p class="text-sm text-gray-600 mb-2">Preguntas r√°pidas:</p>
                            <div class="flex flex-wrap gap-2">
                                <button @click="chatbotQuery = '¬øCu√°l es mi cronograma?'" 
                                        class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                                    üìÖ Cronograma
                                </button>
                                <button @click="chatbotQuery = '¬øCu√°ndo es mi pr√≥ximo pago?'" 
                                        class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                                    üí∞ Pr√≥ximo Pago
                                </button>
                                <button @click="chatbotQuery = '¬øC√≥mo est√° el stock de materiales?'" 
                                        class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                                    üì¶ Stock
                                </button>
                                <button @click="chatbotQuery = '¬øQui√©n est√° trabajando en mi proyecto?'" 
                                        class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                                    üë• Personal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isLoggedIn: false,
                activeTab: 'dashboard',
                user: {},
                kpis: {},
                projects: [],
                milestones: [],
                stock: [],
                suppliers: [],
                employees: [],
                chatbotQuery: '',
                chatbotResponse: null,
                loginForm: {
                    email: '',
                    password: ''
                },

                async login() {
                    try {
                        const response = await fetch('/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.loginForm)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem('token', data.token);
                            this.user = data.user;
                            this.isLoggedIn = true;
                            this.loadProjects();
                            this.loadMilestones();
                        } else {
                            alert('Error en el login. Verifica tus credenciales.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error de conexi√≥n.');
                    }
                },

                logout() {
                    localStorage.removeItem('token');
                    this.isLoggedIn = false;
                    this.user = {};
                    this.kpis = {};
                    this.projects = [];
                    this.milestones = [];
                    this.stock = [];
                    this.suppliers = [];
                    this.employees = [];
                    this.chatbotResponse = null;
                    this.activeTab = 'dashboard';
                },

                async loadKPIs(type) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/kpi/${type}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.kpis[type] = data;
                            
                            // Actualizar gr√°ficos si est√°n disponibles
                            if (type === 'obras' && this.projects.length > 0) {
                                this.updateProjectsChart();
                            }
                            if (type === 'finanzas') {
                                this.updateFinanceChart();
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                async loadProjects() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/proyectos', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.projects = data;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                async loadMilestones() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/proyectos/1/hitos', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.milestones = data;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                async loadStock() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/stock', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.stock = data;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                async loadSuppliers() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/proveedores', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.suppliers = data;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                async loadEmployees() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/empleados', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.employees = data;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                async askChatbot() {
                    if (!this.chatbotQuery.trim()) return;

                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/chatbot/query', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ query: this.chatbotQuery })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.chatbotResponse = data;
                            this.chatbotQuery = '';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                },

                updateProjectsChart() {
                    const ctx = document.getElementById('projectsChart');
                    if (!ctx) return;

                    const statusCounts = {
                        'EN_PROGRESO': 0,
                        'PLANIFICACION': 0,
                        'FINALIZADO': 0
                    };

                    this.projects.forEach(project => {
                        statusCounts[project.estado]++;
                    });

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['En Progreso', 'Planificaci√≥n', 'Finalizado'],
                            datasets: [{
                                data: [statusCounts['EN_PROGRESO'], statusCounts['PLANIFICACION'], statusCounts['FINALIZADO']],
                                backgroundColor: ['#f59e0b', '#3b82f6', '#10b981']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                },

                updateFinanceChart() {
                    const ctx = document.getElementById('financeChart');
                    if (!ctx) return;

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Ingresos', 'Egresos', 'Utilidad'],
                            datasets: [{
                                label: 'Monto ($)',
                                data: [
                                    this.kpis.finanzas?.ingresos || 0,
                                    this.kpis.finanzas?.egresos || 0,
                                    this.kpis.finanzas?.utilidad || 0
                                ],
                                backgroundColor: ['#10b981', '#ef4444', '#3b82f6']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
